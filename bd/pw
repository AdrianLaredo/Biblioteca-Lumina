-- Eliminar tablas si existen (para poder recrear la BD limpia)
DROP TABLE IF EXISTS prestamos;
DROP TABLE IF EXISTS libros;
DROP TABLE IF EXISTS usuarios;

-- Tabla de usuarios
CREATE TABLE usuarios (
    usuario_id INT AUTO_INCREMENT PRIMARY KEY,
    nombres VARCHAR(100) NOT NULL,
    apellidos VARCHAR(100) NOT NULL,
    login VARCHAR(50) UNIQUE NOT NULL,
    password VARCHAR(255) NOT NULL,
    rol ENUM('Estudiante', 'Docente', 'Administrador') NOT NULL,
    email VARCHAR(100) NOT NULL,
    fecha_registro DATETIME DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_rol (rol),
    INDEX idx_login (login)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;


-- Tabla de libros
CREATE TABLE libros (
    libro_id INT AUTO_INCREMENT PRIMARY KEY,
    titulo VARCHAR(255) NOT NULL,
    autor VARCHAR(255) NOT NULL,
    editorial VARCHAR(100) NOT NULL,
    anio_publicacion INT,
    categoria VARCHAR(50) NOT NULL,
    descripcion TEXT,
    portada VARCHAR(255),
    fecha_ingreso DATETIME DEFAULT CURRENT_TIMESTAMP,
    disponible BOOLEAN DEFAULT TRUE,
    INDEX idx_categoria (categoria),
    INDEX idx_autor (autor),
    INDEX idx_titulo (titulo)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Tabla de préstamos
CREATE TABLE prestamos (
    prestamo_id INT AUTO_INCREMENT PRIMARY KEY,
    libro_id INT NOT NULL,
    usuario_id INT NOT NULL,
    fecha_prestamo DATETIME DEFAULT CURRENT_TIMESTAMP,
    fecha_devolucion_esperada DATETIME NOT NULL,
    fecha_devolucion_real DATETIME,
    estado ENUM('Activo', 'Devuelto', 'Atrasado', 'Perdido') DEFAULT 'Activo',
    notificado BOOLEAN DEFAULT FALSE,
    INDEX idx_estado (estado),
    INDEX idx_usuario (usuario_id),
    INDEX idx_libro (libro_id),
    INDEX idx_fecha_devolucion (fecha_devolucion_esperada),
    FOREIGN KEY (libro_id) REFERENCES libros(libro_id) ON DELETE RESTRICT,
    FOREIGN KEY (usuario_id) REFERENCES usuarios(usuario_id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- ============================================
-- INSERCIÓN DE USUARIOS DE PRUEBA
-- ============================================

-- ADMINISTRADORES
INSERT INTO usuarios (nombres, apellidos, login, password, rol, email) VALUES
('Carlos', 'Rodríguez', 'admin', SHA1('admin123'), 'Administrador', 'admin@biblioteca.com'),
('María', 'González', 'mgonzalez', SHA1('admin123'), 'Administrador', 'maria.gonzalez@biblioteca.com');

-- DOCENTES
INSERT INTO usuarios (nombres, apellidos, login, password, rol, email) VALUES
('Ana', 'Martínez', 'amartinez', SHA1('docente123'), 'Docente', 'ana.martinez@universidad.edu'),
('Roberto', 'Sánchez', 'rsanchez', SHA1('docente123'), 'Docente', 'roberto.sanchez@universidad.edu'),
('Laura', 'Fernández', 'lfernandez', SHA1('docente123'), 'Docente', 'laura.fernandez@universidad.edu');

-- ESTUDIANTES
INSERT INTO usuarios (nombres, apellidos, login, password, rol, email) VALUES
('Juan', 'Pérez', 'jperez', SHA1('estudiante123'), 'Estudiante', 'juan.perez@estudiante.edu'),
('Sofía', 'López', 'slopez', SHA1('estudiante123'), 'Estudiante', 'sofia.lopez@estudiante.edu'),
('Diego', 'Ramírez', 'dramirez', SHA1('estudiante123'), 'Estudiante', 'diego.ramirez@estudiante.edu'),
('Camila', 'Torres', 'ctorres', SHA1('estudiante123'), 'Estudiante', 'camila.torres@estudiante.edu'),
('Andrés', 'Vargas', 'avargas', SHA1('estudiante123'), 'Estudiante', 'andres.vargas@estudiante.edu');
-- ============================================
-- INSERCIÓN DE LIBROS
-- ============================================

INSERT INTO libros (titulo, autor, editorial, anio_publicacion, categoria, descripcion, portada, disponible, fecha_ingreso) VALUES
('Cien años de soledad', 'Gabriel García Márquez', 'Alfaguara', 1967, 'Ficción', 'Una novela que narra la historia de la familia Buendía en el pueblo ficticio de Macondo.', 'https://images-na.ssl-images-amazon.com/images/I/51MdCjSdtbL.jpg', FALSE, '2023-01-15 10:00:00'),
('1984', 'George Orwell', 'Penguin Random House', 1949, 'Ficción', 'Una distopía que describe un estado totalitario omnipresente y vigilante.', 'https://images-na.ssl-images-amazon.com/images/I/71kxa1-0mfL.jpg', TRUE, '2023-02-20 11:30:00'),
('El Principito', 'Antoine de Saint-Exupéry', 'Planeta', 1943, 'Ficción', 'Un cuento poético que viene acompañado de ilustraciones hechas por el autor.', 'https://images-na.ssl-images-amazon.com/images/I/61unER5cMsL.jpg', TRUE, '2023-03-10 09:15:00'),
('Don Quijote de la Mancha', 'Miguel de Cervantes', 'Alfaguara', 1605, 'Ficción', 'La obra cuenta las aventuras de un hidalgo que pierde el juicio por leer muchos libros de caballerías.', 'https://images-na.ssl-images-amazon.com/images/I/51QJPTEt9hL.jpg', TRUE, '2023-01-05 14:20:00'),
('Fahrenheit 451', 'Ray Bradbury', 'Penguin Random House', 1953, 'Ficción', 'Una novela distópica donde los libros están prohibidos y los bomberos queman cualquier libro que encuentren.', 'https://images-na.ssl-images-amazon.com/images/I/71OFqSRFDgL.jpg', FALSE, '2023-04-18 16:45:00'),
('Sapiens: De animales a dioses', 'Yuval Noah Harari', 'Debate', 2011, 'No Ficción', 'Un recorrido por la historia de la humanidad, desde la evolución hasta la actualidad.', 'https://images-na.ssl-images-amazon.com/images/I/71RM20u4WEL.jpg', TRUE, '2023-05-22 13:10:00'),
('El arte de la guerra', 'Sun Tzu', 'Gredos', -500, 'Historia', 'Un tratado sobre estrategia militar que sigue siendo influyente hoy en día.', 'https://images-na.ssl-images-amazon.com/images/I/51h-OwruYyL.jpg', TRUE, '2023-02-28 10:30:00'),
('Breve historia del tiempo', 'Stephen Hawking', 'Bantam Books', 1988, 'Ciencia', 'Un libro de divulgación científica que explica varios conceptos de cosmología.', 'https://images-na.ssl-images-amazon.com/images/I/81SHqkAL1SL.jpg', TRUE, '2023-06-15 12:00:00'),
('Clean Code', 'Robert C. Martin', 'Prentice Hall', 2008, 'Tecnología', 'Un libro fundamental sobre buenas prácticas de programación y diseño de software.', 'https://images-na.ssl-images-amazon.com/images/I/41xShlnTZTL.jpg', FALSE, '2023-07-30 15:20:00'),
('Steve Jobs', 'Walter Isaacson', 'HarperCollins', 2011, 'Biografía', 'La biografía autorizada del cofundador de Apple.', 'https://images-na.ssl-images-amazon.com/images/I/81VStYnDGrL.jpg', TRUE, '2023-08-12 11:45:00'),
('El poder del ahora', 'Eckhart Tolle', 'New World Library', 1997, 'Autoayuda', 'Una guía para el crecimiento espiritual y la iluminación.', 'https://images-na.ssl-images-amazon.com/images/I/71yj8oJ+gbL.jpg', TRUE, '2023-09-05 14:30:00'),
('Los 7 hábitos de la gente altamente efectiva', 'Stephen R. Covey', 'Free Press', 1989, 'Autoayuda', 'Un libro de desarrollo personal que presenta siete principios para ser más efectivo.', 'https://images-na.ssl-images-amazon.com/images/I/51fEz6pALIL.jpg', TRUE, '2023-10-18 10:15:00'),
('El nombre del viento', 'Patrick Rothfuss', 'DAW Books', 2007, 'Ficción', 'Primer libro de la trilogía Crónica del asesino de reyes.', 'https://images-na.ssl-images-amazon.com/images/I/91b8oNwaURL.jpg', FALSE, '2023-11-22 09:30:00'),
('El código Da Vinci', 'Dan Brown', 'Doubleday', 2003, 'Ficción', 'Una novela de misterio que mezcla suspense con teorías conspirativas.', 'https://images-na.ssl-images-amazon.com/images/I/815WORuYMML.jpg', TRUE, '2023-12-10 16:20:00'),
('Thinking, Fast and Slow', 'Daniel Kahneman', 'Farrar, Straus and Giroux', 2011, 'Psicología', 'Un libro que explora los dos sistemas que modelan cómo pensamos.', 'https://images-na.ssl-images-amazon.com/images/I/71NblNGnNqL.jpg', TRUE, '2024-01-15 14:00:00'),
('El alquimista', 'Paulo Coelho', 'HarperCollins', 1988, 'Ficción', 'Una novela sobre un joven pastor que viaja en busca de un tesoro.', 'https://images-na.ssl-images-amazon.com/images/I/71aFt4+OTOL.jpg', TRUE, '2024-02-20 11:10:00'),
('La sombra del viento', 'Carlos Ruiz Zafón', 'Planeta', 2001, 'Ficción', 'Primera novela de la serie El cementerio de los libros olvidados.', 'https://images-na.ssl-images-amazon.com/images/I/91hKxPANDcL.jpg', TRUE, '2024-03-05 13:45:00'),
('Hábitos atómicos', 'James Clear', 'Avery', 2018, 'Autoayuda', 'Una guía para construir buenos hábitos y romper los malos.', 'https://images-na.ssl-images-amazon.com/images/I/91bYsX41DVL.jpg', TRUE, '2024-04-10 10:30:00'),
('El hombre en busca de sentido', 'Viktor E. Frankl', 'Beacon Press', 1946, 'Biografía', 'Un relato de las experiencias del autor en campos de concentración nazis.', 'https://images-na.ssl-images-amazon.com/images/I/71QKQ9mwV7L.jpg', TRUE, '2024-05-15 15:20:00'),
('Crimen y castigo', 'Fyodor Dostoevsky', 'The Russian Messenger', 1866, 'Ficción', 'Una novela psicológica sobre un estudiante que comete un crimen.', 'https://images-na.ssl-images-amazon.com/images/I/71O2XIytdqL.jpg', TRUE, '2024-06-20 12:30:00'),
('El señor de los anillos', 'J.R.R. Tolkien', 'Minotauro', 1954, 'Ficción', 'La épica aventura de Frodo para destruir el Anillo Único.', 'https://images-na.ssl-images-amazon.com/images/I/91jBdIDZeQL.jpg', TRUE, '2024-07-01 09:00:00'),
('Introducción a los algoritmos', 'Thomas H. Cormen', 'MIT Press', 2009, 'Tecnología', 'Libro esencial sobre algoritmos y estructuras de datos.', 'https://images-na.ssl-images-amazon.com/images/I/61Pgdn8Ys-L.jpg', TRUE, '2024-08-15 11:30:00'),
('El gen egoísta', 'Richard Dawkins', 'Oxford University Press', 1976, 'Ciencia', 'Una perspectiva revolucionaria sobre la evolución.', 'https://images-na.ssl-images-amazon.com/images/I/71cXwI5QRVL.jpg', TRUE, '2024-09-20 14:15:00'),
('Orgullo y prejuicio', 'Jane Austen', 'Penguin Classics', 1813, 'Ficción', 'Una novela romántica sobre Elizabeth Bennet y el señor Darcy.', 'https://images-na.ssl-images-amazon.com/images/I/71Q1tPupKjL.jpg', TRUE, '2024-10-05 16:45:00'),
('La metamorfosis', 'Franz Kafka', 'Alianza Editorial', 1915, 'Ficción', 'La inquietante historia de Gregor Samsa que despierta convertido en insecto.', 'https://images-na.ssl-images-amazon.com/images/I/71qKQ8xKa3L.jpg', TRUE, '2024-11-10 10:20:00');

-- ============================================
-- INSERCIÓN DE PRÉSTAMOS
-- ============================================

-- Préstamos activos (libros en posesión de estudiantes)
INSERT INTO prestamos (libro_id, usuario_id, fecha_prestamo, fecha_devolucion_esperada, estado, notificado) VALUES
-- Juan Pérez tiene "Cien años de soledad" (ID 1) y está próximo a vencer
(1, 3, '2025-11-20 10:00:00', '2025-11-27 23:59:59', 'Activo', FALSE),
-- Sofía López tiene "Fahrenheit 451" (ID 5)
(5, 4, '2025-11-22 14:30:00', '2025-11-29 23:59:59', 'Activo', FALSE),
-- Diego Ramírez tiene "Clean Code" (ID 9)
(9, 5, '2025-11-23 09:15:00', '2025-11-30 23:59:59', 'Activo', FALSE),
-- Camila Torres tiene "El nombre del viento" (ID 13)
(13, 6, '2025-11-21 16:20:00', '2025-11-28 23:59:59', 'Activo', FALSE);

-- Préstamos devueltos (historial)
INSERT INTO prestamos (libro_id, usuario_id, fecha_prestamo, fecha_devolucion_esperada, fecha_devolucion_real, estado, notificado) VALUES
(2, 3, '2025-10-01 10:00:00', '2025-10-08 23:59:59', '2025-10-07 14:30:00', 'Devuelto', TRUE),
(3, 4, '2025-10-05 11:20:00', '2025-10-12 23:59:59', '2025-10-12 09:45:00', 'Devuelto', TRUE),
(4, 5, '2025-10-10 13:15:00', '2025-10-17 23:59:59', '2025-10-16 16:20:00', 'Devuelto', TRUE),
(6, 6, '2025-10-15 09:30:00', '2025-10-22 23:59:59', '2025-10-21 11:10:00', 'Devuelto', TRUE),
(7, 7, '2025-10-20 14:00:00', '2025-10-27 23:59:59', '2025-10-26 15:30:00', 'Devuelto', TRUE),
(8, 3, '2025-11-01 10:30:00', '2025-11-08 23:59:59', '2025-11-08 12:00:00', 'Devuelto', TRUE),
(10, 4, '2025-11-05 11:45:00', '2025-11-12 23:59:59', '2025-11-11 14:20:00', 'Devuelto', TRUE);
